<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Garmin House T&H</title>
    <link rel="stylesheet" href="{{url_for('static',filename='dist/css/output.css')}}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.27.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@0.1.1"></script>
    <script>
    // On page load or when changing themes, best to add inline in `head` to avoid FOUC
    if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
    } else {
        document.documentElement.classList.remove('dark')
    }
</script>
</head>
<body class="bg-white dark:bg-slate-800">
<div class="m-auto max-w-screen-xl ">

    <div class="relative mt-2 mb-4 text-center text-3xl font-extrabold leading-none tracking-tight dark:text-white md:text-4xl lg:text-5xl border border-black dark:border-white p-2 rounded">
        <div class="absolute top-0 right-0 pr-4">
        <button id="theme-toggle" type="button"
                class="text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-700 rounded-lg text-sm p-2.5">
            <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
            </svg>
            <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"
                 xmlns="http://www.w3.org/2000/svg">
                <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z"
                      fill-rule="evenodd" clip-rule="evenodd"></path>
            </svg>
        </button>
    </div>
        Garmin House
    </div>

    <div class=" grid lg:grid-cols-2 gap-8">
        {% for room_id in ['salon', 'pierre', 'coco', 'gui', 'sim'] %}
        <div class="">
            <!-- Room Header: Name, Temperature, Humidity, Status -->
            <div class="grid grid-cols-4 mb-2 text-2xl dark:text-slate-300 md:text-3xl lg:text-4xl px-4">

                <!-- Room Name -->
                <div class="text-center me-2 px-2.5 py-0.5">{{ room_id }}</div>

                <!-- Temperature -->
                {% set temp = data_live.get(room_id, {}).get('temp', 'NaN') %}
                <div class=" text-center rounded font-medium me-2 px-2.5 py-0.5
                {% if temp < 16 %}bg-red-300 text-red-900 dark:bg-red-900 dark:text-red-300
                {% elif temp < 18 %}bg-orange-200 text-yellow-700 dark:bg-yellow-700 dark:text-orange-200
                {% else %}bg-green-300 text-green-900 dark:bg-green-900 dark:text-green-300
                {% endif %}">
                    {{ temp }}<span class="sm:text-xs md:text-sm lg:text-md">°C</span>
                </div>

                <!-- Humidity -->
                {% set humidity = data_live.get(room_id, {}).get('hum', 0) %}
                <div class="text-center rounded font-medium me-2 px-2.5 py-0.5
                {% if humidity > 80 %}bg-red-300 text-red-900 dark:bg-red-900 dark:text-red-300
                {% elif humidity > 70 %}bg-orange-200 text-yellow-700 dark:bg-yellow-700 dark:text-orange-200
                {% else %}bg-green-300 text-green-900 dark:bg-green-900 dark:text-green-300
                {% endif %}">
                    {{ humidity }}<span class="sm:text-xs md:text-sm lg:text-md">%</span>
                </div>

                <!-- Live Status -->
                {% set datetime_status = data_live.get(room_id, {}).get('datetime', '') %}
                <div class="text-center rounded text-s font-medium me-2 px-2.5 py-0.5
                {% if datetime_status == 'live' %}bg-green-300 text-green-900 dark:bg-green-900 dark:text-green-300
                {% else %}bg-gray-300 text-gray-900 dark:bg-gray-900 dark:text-gray-300
                {% endif %}">
                    {{ datetime_status }}
                </div>
            </div>

            <!-- Chart -->
            <div class="hidden lg:flex col-span-8">
                <canvas id="chart-{{ room_id }}"></canvas>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<script>

    var themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
    var themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

    // Change the icons inside the button based on previous settings
    if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        themeToggleLightIcon.classList.remove('hidden');
    } else {
        themeToggleDarkIcon.classList.remove('hidden');
    }

    var themeToggleBtn = document.getElementById('theme-toggle');

    themeToggleBtn.addEventListener('click', function () {

        // toggle icons inside button
        themeToggleDarkIcon.classList.toggle('hidden');
        themeToggleLightIcon.classList.toggle('hidden');

        // if set via local storage previously
        if (localStorage.getItem('color-theme')) {
            if (localStorage.getItem('color-theme') === 'light') {
                document.documentElement.classList.add('dark');
                localStorage.setItem('color-theme', 'dark');
            } else {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('color-theme', 'light');
            }

            // if NOT set via local storage previously
        } else {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.setItem('color-theme', 'light');
            } else {
                document.documentElement.classList.add('dark');
                localStorage.setItem('color-theme', 'dark');
            }
        }

    });

    function fetchChartData(deviceId) {
        fetch(`/last_12_hours_data?device=${deviceId}`)
            .then(response => response.json())
            .then(data => {
                const times = data.times;
                const temps = data.temps;
                const hums = data.hums;
                // Create the chart with Chart.js
                const ctx = document.getElementById(`chart-${deviceId}`).getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: times.map((time) => new Date(time)),  //Time labels
                        datasets: [{
                            label: 'Temperature (°C)',
                            data: temps,  // Temperature values
                            borderColor: 'coral',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            fill: false,
                            tension: 0.4,  // Smooth curve
                            pointRadius: 0,  // Dot markers
                            pointBackgroundColor: 'coral',  // Dot color
                            borderWidth: 2,  // Line width
                            pointHoverRadius: 8,  // Hover effect on dot
                            pointHoverBackgroundColor: 'coral',  // Hover dot color
                            yAxisID: 'y',
                        }, {
                            label: 'Humidity (%)',
                            data: hums,  // Humidity values
                            borderColor: 'cyan',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            fill: false,
                            tension: 0.4,  // Smooth curve
                            pointRadius: 0,  // Dot markers
                            pointBackgroundColor: 'cyan',  // Dot color
                            borderWidth: 2,  // Line width
                            pointHoverRadius: 8,  // Hover effect on dot
                            pointHoverBackgroundColor: 'cyan',  // Hover dot color
                            yAxisID: 'y1',
                        }]
                    },
                    options: {
                        responsive: true,
                        stacked: false,
                        plugins: {
                            tooltip: {
                                mode: 'index',  // Tooltip displays all dataset values for a single point
                                intersect: false,  // Tooltip will show for any series line when hovering over the point
                            },
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'minute',         // Use 'minute' as the unit for time
                                    stepSize: 30,           // Display a tick every 15 minutes
                                },
                                ticks: {
                                    autoSkip: true,         // Automatically skips ticks if there are too many
                                    maxRotation: 0,         // Prevent tick labels from rotating
                                    minRotation: 0,
                                },
                                grid: {
                                    display: false,  // Remove grid
                                },
                            },

                            // Left axis for Temperature
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                grid: {
                                    display: false,  // Remove grid
                                },
                                ticks: {
                                    color: 'coral',  // Color of tick labels for Temperature
                                },
                                min: 15,  // Set minimum value for Temperature Y-axis
                                max: 25,  // Set maximum value for Temperature Y-axis
                                title: {
                                    display: true,  // Display the title for the y-axis
                                    text: 'Température °C',  // Axis title
                                    font: {
                                        size: 16,  // Font size for the title
                                    },
                                    color: 'coral',  // Title color
                                }
                            },
                            // Right axis for Humidity
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                grid: {
                                    display: false,  // Remove grid
                                },
                                ticks: {
                                    color: 'cyan',  // Color of tick labels for Humidity
                                },
                                min: 40,  // Set minimum value for Temperature Y-axis
                                max: 100,  // Set maximum value for Temperature Y-axis
                                title: {
                                    display: true,  // Display the title for the y-axis
                                    text: 'Humidité %',  // Axis title
                                    font: {
                                        size: 16,  // Font size for the title
                                    },
                                    color: 'cyan',  // Title color
                                }
                            },
                        },
                        interaction: {
                            mode: 'index',  // Enable tooltip on both series
                            intersect: false,  // Show tooltip for any dataset when hovering over the point
                        },
                        elements: {
                            line: {
                                tension: 0.4,  // Smooth curve
                                borderWidth: 2,  // Line width
                            },
                            point: {
                                radius: 5,  // Dot size
                                hoverRadius: 8,  // Hover effect on dot
                                hitRadius: 10,  // Area around the dot to trigger hover
                            },
                        },
                    }
                });

            })
            .catch(error => console.error(`Error fetching chart data ${deviceId}:`, error));

    }

    const rooms = ["salon", "pierre", "coco", "gui", "sim"];
    window.onload = function () {
        for (deviceId of rooms) {
            fetchChartData(deviceId);
        }
        ;
    }
</script>
</body>
</html>